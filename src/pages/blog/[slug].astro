---
import bookmarkPlugin from "@notion-render/bookmark-plugin";
import { NotionRenderer } from "@notion-render/client";
import hljsPlugin from "@notion-render/hljs-plugin";
import type { GetStaticPaths } from "astro";
import { NOTION_POSTS_DB } from "astro:env/server";
import MainLayout from "../../layouts/mainLayout.astro";
import {
  getPageBySlug,
  getPageContent,
  getPages,
  notionClient,
} from "../../utils/DB";

// This only runs suring the build time of the pages, it gets all the available slugs
export const getStaticPaths = (async () => {
  return await getPages({
    databaseID: NOTION_POSTS_DB,
    // We want to build all the pages, for viewing and testing, the link for the user
    // to navigate to the post will not be created.
    publishedOnly: false,
  }).then((data) =>
    data.results
      //@ts-expect-error: Notion does not supply a full type coverage for it's tables
      .map(({ properties }) => {
        return {
          params: {
            slug: properties.Slug.rich_text[0].plain_text as string,
          },
        };
      })
  );
}) satisfies GetStaticPaths;

const { slug } = Astro.params as {
  slug: string;
};

// only runs during build time, fetch all the post content by slug
const post = await getPageBySlug(slug as string, NOTION_POSTS_DB);
if (!post) {
  return {
    status: 404,
    error: new Error(`Post not found`),
  };
}
// @ts-ignore: Notion does not supply a full type coverage for it's tables
const title = post.properties.Title.title[0].plain_text;
// @ts-ignore: Notion does not supply a full type coverage for it's tables
const image = post.properties.BannerImage.url;
const content = await getPageContent(post.id);

const notionRenderer = new NotionRenderer({
  client: notionClient,
});

await notionRenderer.use(hljsPlugin({}));
await notionRenderer.use(bookmarkPlugin(undefined));
const html = await notionRenderer.render(...content);
---

<MainLayout>
  <article class="mb-10 flex w-full flex-col items-center px-2 pt-10">
    <div
      transition:name="post"
      class="flex flex-col justify-center items-center"
    >
      <h1 transition:name="postTitle" class="mb-8 text-6xl font-black">
        {title}
      </h1>
      <img
        transition:name="postBannerImage"
        alt="Blog Image"
        src={image}
        class="[width: 800px]!"
      />
    </div>
    <div
      class="mt-4 max-w-4xl space-y-6 text-xl leading-10 prose lg:prose-xl
            prose-headings:font-bold prose-headings:text-pacamara-accent
            prose-p:text-pacamara-primary/70 lg:prose-p:text-[18px] prose-p:transition-all prose-p:duration-300
            prose-a:font-semibold prose-a:text-pacamara-dark prose-a:hover:text-pacamara-pink prose-a:no-underline prose-a:transition-all prose-a:duration-300
            prose-strong:font-normal
            prose-headings:font-pacamara-space prose-h2:mb-7
            dark:prose-a:text-white dark:prose-a:hover:text-pacamara-accent dark:prose-p:text-white/70"
      set:html={html}
    />
  </article>
</MainLayout>

<style is:global>
  .notion-heading_1 {
    @apply text-4xl font-bold my-2;
  }

  .notion-heading_2 {
    @apply text-3xl font-bold my-1;
  }

  .notion-heading_3 {
    @apply text-2xl font-bold mb-5;
  }

  .notion-heading_4 {
    @apply text-xl font-bold;
  }

  .notion-heading_5 {
    @apply text-lg font-bold;
  }

  .notion-heading_6 {
    @apply text-base font-bold;
  }

  .notion-bulleted_list {
    @apply list-disc pr-4 pl-6;
  }

  summary {
    @apply cursor-pointer;
  }

  p {
    @apply text-lg mt-0;
  }

  pre {
    @apply my-0;
  }

  .notion-code {
    @apply rounded-md dark:bg-gray-200 bg-gray-200 px-4 py-0 text-sm mb-2 mt-2 overflow-auto;
    direction: ltr;
  }

  .notion-text-href {
    @apply text-blue-500 dark:text-blue-300 underline visited:text-violet-600 visited:dark:text-violet-400 hover:text-blue-600 hover:dark:text-blue-400 visited:hover:text-violet-600 visited:hover:dark:text-violet-400;
  }

  .notion-quote {
    @apply pr-4 mb-5 mt-5 italic text-gray-500 dark:text-gray-400;
  }

  .hljs-keyword {
    @apply font-semibold text-purple-700 dark:text-purple-300;
  }

  .hljs-string {
    @apply text-green-600 dark:text-green-300;
  }

  .hljs-title.function_,
  .hljs-title.class_ {
    @apply font-semibold text-red-300 dark:text-red-300;
  }

  .hljs-attr {
    @apply text-indigo-600 dark:text-indigo-400;
  }

  .hljs-comment {
    @apply italic text-gray-500 dark:text-gray-400;
  }

  .hljs-name {
    @apply text-teal-200 dark:text-teal-200;
  }

  .notion-text-bold {
    @apply font-bold;
  }

  .notion-text-code {
    @apply inline-block rounded dark:bg-gray-200 bg-gray-400 px-2;
    direction: ltr;
  }

  .notion-heading_1 {
    @apply mb-4 mt-5 font-bold;
  }

  .notion-numbered_list .notion-numbered_list_item::marker {
    @apply text-slate-900 dark:text-slate-100;
  }

  .notion-numbered_list {
    @apply list-decimal pl-6;
  }

  .notion-numbered_list_item {
    @apply mb-2;
  }

  .notion-color-default {
    @apply text-gray-800 dark:text-gray-300;
  }

  .notion-bulleted_list_item {
    @apply mb-2;
  }

  .notion-image {
    @apply mb-5 mt-5;
  }

  .notion-image > img {
    @apply rounded-lg;
  }

  .notion-color-yellow_background {
    @apply bg-yellow-100 dark:bg-yellow-800;
  }

  .notion-color-red_background {
    @apply bg-red-100 dark:bg-red-800;
  }

  .notion-color-blue_background {
    @apply bg-blue-100 dark:bg-blue-800;
  }

  .notion-color-green_background {
    @apply bg-green-100 dark:bg-green-800;
  }

  .notion-color-gray_background {
    @apply bg-gray-100 dark:bg-gray-800;
  }

  .notion-color_orange_background {
    @apply bg-orange-100 dark:bg-orange-800;
  }

  .notion-color_purple_background {
    @apply bg-purple-100 dark:bg-purple-800;
  }
</style>
